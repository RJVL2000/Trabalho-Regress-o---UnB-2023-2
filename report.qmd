---
title: "Trabalho Final"
subtitle: "REGRESSÃO LINEAR"
author: "Camila, Maria Clara, Rafael & Tailine"
date: "12/21/2023"
format: html
---

```{r}
#| message: false
#| echo: false
if (!require(pacman)) install.packages("pacman")
pacman::p_load(tidyverse,readxl,GGally,knitr,MASS,lmtest,DescTools)
```

```{r}
# Importação de dados e renomeação de variáveis

dados <- read_excel(#"C:/Users/User/Documents/GitHub/Trabalho-Regressao_UnB-2023-2/
"Dados/Dados_trabalho_20232.xlsx")[-1]

names(dados) <- c(
    "tempo_internacao", "idade", "prob_infeccao", "prop_culturas_rotina",
    "prop_raio_x_torax_rotina", "quant_leitos", "filiacao_escola_medicina", "regiao",
    "media_pacientes", "quant_enfermeiros", "servicos_disponiveis"
)

# Tratamento de variáveis categóricas
dados_trat <- dados %>%
    mutate(
        filiacao_escola_medicina = as.factor(filiacao_escola_medicina),
        regiao = as.factor(regiao),
        servicos_disponiveis2 = servicos_disponiveis^2
        )

# Separando o banco em dados de treino e de validação
set.seed(2023)
indexes <- 1:nrow(dados_trat)
index_treino <- sort(sample(indexes, 60))
index_valid <- indexes[!(indexes %in% index_treino)]
dados_treino <- dados_trat[index_treino, ]
dados_valid <- dados_trat[index_valid, ]
```




# Modelos
## Hipotese 1
Espera-se	 que	 o	 número	 de	 enfermeira(o)s	 esteja	 relacionado	 às	 instalações e	 serviços	disponíveis	através de	um	modelo	de	segunda	ordem.	Suspeita-se	também	que	varie	segundo	a	região.


- Modelo 1: $X_{10} = \beta_0 + \beta_{8} \cdot X_8 + \beta_{11} \cdot X_{11}^2$


```{r}
# Modelo 1 - todas, sem trasnformação
modelo1 <- lm(quant_enfermeiros ~ servicos_disponiveis2 + regiao, dados_treino)
summary(modelo1)

residuos1 <- modelo1$residuals
plot(residuos1)
shapiro.test(residuos1) #nao atendido
bptest(modelo1) #nao atendido

```

- Modelo 2: $ln(X_{10}) = \beta_0 + \beta_{8} \cdot X_8 + \beta_{11} \cdot X_{11}^2$

```{r}
# Modelo 2 - todas, log
modelo2 <- lm(log(quant_enfermeiros) ~ servicos_disponiveis2 + regiao, dados_treino)
summary(modelo2)

residuos2 <- modelo2$residuals
plot(residuos2)
shapiro.test(residuos2) #atendido
bptest(modelo2) #atendido
```

- Modelo 3: $ln(X_{10}) = \beta_0 + \beta_{11} \cdot X_{11}^2$
```{r}
# Modelo 3 - servicos, log
modelo3 <- lm(log(quant_enfermeiros) ~ servicos_disponiveis2, dados_treino)
summary(modelo3)

residuos3 <- modelo3$residuals
plot(residuos3)
shapiro.test(residuos3) #atendido
bptest(modelo3) #atendido

# Medidas de ajuste do primeiro modelo
rse3 <- sigma(modelo3)
rmse3 <- sqrt(mean(modelo3$residuals^2))
rsquared3 <- summary(modelo3)$r.squared
adjusted_rsquared3 <- summary(modelo3)$adj.r.squared
f_statistic3 <- summary(modelo3)$fstatistic[1]
aic3 <- AIC(modelo3)
bic3 <- BIC(modelo3)

medidas<-data.frame(rse3,rmse3,rsquared3,adjusted_rsquared3,f_statistic3,aic3,bic3)
names(medidas) <- c('RSE','RMSE','R2','R2ad','F','AIC','BIC')
kable(medidas)
```


## Hipotese 2

```{r}
modelo12 <- lm(log(tempo_internacao) ~ ., data = dados_treino)
VIF(modelo12)

## Remoção de variáveis correlacionadas
modelo22 <- lm(log(tempo_internacao) ~ ., data = dados_treino %>% mutate(
    quant_leitos = NULL,
    media_pacientes = NULL,
    servicos_disponiveis = NULL,
    prob_infeccao = NULL
))
VIF(modelo22)

modelo32 <- step(modelo22, direction = "both")
summary(modelo32)

# Teste dos pressupostos para o segundo modelo
residuos32 <- modelo32$residuals
shapiro.test(residuos32)
plot(residuos32)
bptest(modelo32)

# Medidas de ajuste do segundo modelo
rse32 <- sigma(modelo32)
rmse32 <- sqrt(mean(modelo32$residuals^2))
rsquared32 <- summary(modelo32)$r.squared
adjusted_rsquared32 <- summary(modelo32)$adj.r.squared
f_statistic32 <- summary(modelo32)$fstatistic[1]
aic32 <- AIC(modelo32)
bic32 <- BIC(modelo32)


# Gerando previsões para os dados de validação
prev_tempo_internacao <- exp(predict(modelo32, newdata = dados_valid))
res_valid <- dados_valid$tempo_internacao - prev_tempo_internacao
rmse_valid <- sqrt(mean(res_valid))
shapiro.test(res_valid)
plot(res_valid)
```

## Gráficos
```{r}
dados_treino %>% ggplot(aes(x = filiacao_escola_medicina, y = tempo_internacao)) +
    geom_boxplot(fill='blue')+
    xlab('Filiação Escola de Medicina')+
    ylab('Tempo de Internação')+
    theme_classic()

dados_treino %>% ggplot(aes(x = regiao, y = tempo_internacao)) +
    geom_boxplot(fill='blue')+
    xlab('Região')+
    ylab('Tempo de Internação')+
    theme_classic()

dados_treino %>% ggplot(aes(x = filiacao_escola_medicina, y = quant_enfermeiros)) +
    geom_boxplot(fill='blue')+
    xlab('Filiação Escola de Medicina')+
    ylab('Quantidade de Enfermeiros')+
    theme_classic()

dados_treino %>% ggplot(aes(x = regiao, y = quant_enfermeiros)) +
    geom_boxplot(fill='blue')+
    xlab('Região')+
    ylab('Quantidade de Enfermeiros')+
    theme_classic()

```
